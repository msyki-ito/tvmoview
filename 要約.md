主要ファイルの要約です。

ファイル : MainActivity.kt
役割    : アプリのエントリポイント 兼 画面ナビゲーション親

● グローバル
  - mediaRepository : MediaRepository            // テスト用ローカルデータ
  - authManager     : AuthenticationManager      // MS OAuth2 認証
  - oneDriveRepository : OneDriveRepository      // OneDrive API 操作

● onCreate()
  1. mediaRepository 初期化（テストデータ）
  2. AuthenticationManager / OneDriveRepository を生成
  3. setContent → TVMovieTheme 内で AuthenticationWrapper()

● AuthenticationWrapper() @Composable
  - AuthState(Check/OK/NG) を判定し画面を振り分け  
      * Authenticated → AppNavigation()  
      * NotAuthenticated → LoginScreen()  
      * Checking → 簡易ローディング

● AppNavigation() @Composable
  NavHost ルート:
    - "home"   → ModernMediaBrowser
    - "folder/{folderId}" → ModernMediaBrowser(子フォルダ)
    - "player/{itemId}/{downloadUrl}" → HighQualityPlayerScreen
    - "image/{itemId}" → 画像ビューア (未実装)
    - "settings" → SettingsScreen

  * ModernMediaBrowser から動画選択時  
    → downloadUrl を URL エンコードして player 画面へ  
  * OAuth コールバックは handleAuthRedirect() で処理

● handleAuthRedirect(Intent)
  - スキーム msauth://com.example.tvmoview をフック
  - ?code=xxx を取り出しログ出力（トークン交換 TBD）
●ポイント
“認証判定→ナビゲーション” のハブが AuthenticationWrapper。
AppNavigation() がルート 5 画面を管理。
OneDrive 統合は AuthenticationManager と OneDriveRepository に委譲。


ファイル : ModernMediaBrowser.kt
役割    : OneDrive / ローカルのメディアをブラウズする TV 向け一覧 UI
依存    : MediaBrowserViewModel, ModernTileView, ModernListView ほか

● 外部 API
  ModernMediaBrowser(
      folderId: String? = null,
      onMediaSelected: (MediaItem) -> Unit,
      onFolderSelected: (folderId: String) -> Unit,
      onSettingsClick: () -> Unit = null,
      onBackClick: () -> Unit = null
  )

● 画面構成
  └─ Column
       ├─ ModernTopBar     ← ビュー切替・並び替え・設定・戻る
       └─ コンテンツ Box
           • ローディング     → CircularProgress
           • 空フォルダ        → EmptyStateView()
           • 一覧表示
               ‣ ViewMode.TILE → ModernTileView (3×? グリッド)
               ‣ ViewMode.LIST → ModernListView (縦リスト)

● データ取得フロー
  LaunchedEffect(folderId) { viewModel.loadItems(folderId) }
    └─ OneDriveRepository から items Flow を購読

● イベント分岐
  - フォルダ item クリック → onFolderSelected(item.id)
  - 動画 / 画像 item クリック
      • Log 出力 (名前 & downloadUrl)
      • onMediaSelected(item)  // 親が NavHost で遷移処理

● 並び替え
  - TopBar の「Sort」押下 → SortDialog 表示
  - SortDialog RadioButton → viewModel.setSortBy(sort)

● ViewMode 切替
  - TopBar のアイコン押下 → viewModel.toggleViewMode()
    ‣ Tile <-> List をリアルタイム変更

● OneDrive 状態表示（デバッグ）
  - `authManager.isAuthenticated()` が true の時
    → 画面右下に 「🔐 OneDrive接続中」 バッジを表示
●ポイント
ModernMediaBrowser は “データ取得・ソート・表示切替” を ViewModel で完結。
フォルダ遷移とメディア起動は 引数コールバック に委譲し、画面側で NavHost を制御。
高速 UI 切替のため、Tile / List はそれぞれ独自 Compose コンポーネントに分離。



ファイル : HighQualityPlayerScreen.kt
役割    : Media3 ExoPlayer を使った TV 向け高機能プレイヤー画面

● 外部 API
  HighQualityPlayerScreen(
      itemId      : String,            // MediaItem ID
      onBack      : () -> Unit,        // 戻るコールバック
      downloadUrl : String = ""        // OneDrive 直 URL（あれば）
  )

● 主なロジック
  1. ExoPlayer を remember で生成
     • downloadUrl が空なら OneDriveRepository へフォールバック
  2. TV リモコン操作を onKeyEvent でハンドリング
     ⏩/⏪ 15 秒シーク・音量 ±・再生/一時停止・戻るダブルプレス
  3. 独自シーク UI
     • seek 時に `showSeekBarTemporarily()` で 1 秒表示
  4. 画面バックハンドラ
     • 戻るボタン 2 回押しで exit、それ以外は PlayerView コントローラを隠す
  5. DisposableEffect で release()

● 関連補助関数
  - formatTime(timeMs)           // mm:ss 変換
  - getVideoUrlSafely()          // downloadUrl → OneDrive → テスト動画の順
  - getOneDriveVideoUrl()        // itemId から簡易 URL 構築（要実装）
  - getTestVideoUrl()            // サンプル動画 fallback

● キーイベントマッピング
  Key.Right         → +15s シーク
  Key.Left          → –15s シーク
  Key.Up / Down     → 音量 ±0.1
  Key.Center / Play → 再生↔停止
  Key.Back          → ダブルプレスで onBack()

● UI 構成
  Box(Black bg)
    └─ AndroidView< PlayerView >
       +   （Overlay）Card + LinearProgress (一時的カスタムシーク)


ファイル : HighQualityPlayerScreen.kt
役割    : Media3 ExoPlayer を使った TV 向け高機能プレイヤー画面

● 外部 API
  HighQualityPlayerScreen(
      itemId      : String,            // MediaItem ID
      onBack      : () -> Unit,        // 戻るコールバック
      downloadUrl : String = ""        // OneDrive 直 URL（あれば）
  )

● 主なロジック
  1. ExoPlayer を remember で生成
     • downloadUrl が空なら OneDriveRepository へフォールバック
  2. TV リモコン操作を onKeyEvent でハンドリング
     ⏩/⏪ 15 秒シーク・音量 ±・再生/一時停止・戻るダブルプレス
  3. 独自シーク UI
     • seek 時に `showSeekBarTemporarily()` で 1 秒表示
  4. 画面バックハンドラ
     • 戻るボタン 2 回押しで exit、それ以外は PlayerView コントローラを隠す
  5. DisposableEffect で release()

● 関連補助関数
  - formatTime(timeMs)           // mm:ss 変換
  - getVideoUrlSafely()          // downloadUrl → OneDrive → テスト動画の順
  - getOneDriveVideoUrl()        // itemId から簡易 URL 構築（要実装）
  - getTestVideoUrl()            // サンプル動画 fallback

● キーイベントマッピング
  Key.Right         → +15s シーク
  Key.Left          → –15s シーク
  Key.Up / Down     → 音量 ±0.1
  Key.Center / Play → 再生↔停止
  Key.Back          → ダブルプレスで onBack()

● UI 構成
  Box(Black bg)
    └─ AndroidView< PlayerView >
       +   （Overlay）Card + LinearProgress (一時的カスタムシーク)
●ポイント
TV リモコン専用 UX（キーコードに直接バインド）。
showSeekBarTemporarily() がプレイヤー状態を読み取り、自作シークバーを Overlay 表示。
URL 解決は downloadUrl が最優先、無い場合は OneDriveRepository へフォールバックし、失敗時はテスト動画。




ファイル : AuthenticationManager.kt
役割    : Microsoft アカウント “Device Code Flow” を使った TV 向け OAuth2 認証

● 設定定数
  clientId  = "c7981c06-…"
  tenantId  = "consumers"
  scope     = "https://graph.microsoft.com/Files.Read offline_access"

● 内部データクラス
  - DeviceCodeResponse(deviceCode, userCode, verificationUri, expiresIn, interval)
  - TokenResponse(accessToken, refreshToken?, expiresIn)
  - AuthToken(accessToken, refreshToken?, expiresAt)

● 公開メソッド
  suspend fun startDeviceCodeFlow(): DeviceCodeResponse
      • /devicecode エンドポイント呼び出し
      • userCode / verificationUri を返却 (TV でユーザーに提示)

  suspend fun pollForToken(deviceCode, interval): TokenResponse
      • 指定 interval (sec) で /token をポーリング
      • access_token を取得したら SharedPreferences に保存

  fun getSavedToken(): AuthToken?        // prefs から読込
  fun isAuthenticated(): Boolean         // 期限チェック付き
  fun clearAuthentication()              // prefs 全クリア

● 内部処理ポイント
  - OkHttp + coroutine(Dispatchers.IO) を使用
  - ポーリングは最大 60 回 (≈5 分) でタイムアウト
  - エラーコード別に細かく例外を投げ分け
      • authorization_pending / declined / expired_token
  - 保存時に expiresAt = now + expiresIn*1000 で期限管理

● TV 向け仕様
  - 従来のブラウザリダイレクト Flow (`startAuthentication()`) は Unsupported
  - Device Code Flow に限定し、スマホ or PC ブラウザで認証させる方式
 
  



ファイル : OneDriveRepository.kt
役割    : Microsoft Graph API → MediaItem 変換 & downloadUrl 付与

● 依存
  - AuthenticationManager        // アクセストークン取得・検証
  - OneDriveApiService (Retrofit)// /me/drive エンドポイント
  - OkHttp                       // 個別ファイル詳細呼び出し

● 公開 API
  suspend fun getRootItems():   List<MediaItem>
  suspend fun getFolderItems(folderId): List<MediaItem>
  suspend fun getDownloadUrl(itemId):   String?   // 動画だけ追加取得
  fun    getCurrentPath(folderId?):     String

● データ取得フロー
  1. 認証トークン取得 → 期限チェック
  2. /children API で OneDriveItem list を取得
  3. OneDriveItem.toMediaItem() で UI 用へ変換
  4. isVideo のものだけ OkHttp で `/items/{id}` を叩き
     → `@microsoft.graph.downloadUrl` をパースし MediaItem にコピー

● 内部メソッド
  - parseDownloadUrlFromResponse(json) : String?
      • JSON から downloadUrl 抽出
  - OneDriveItem.toMediaItem()
      • フォルダ / ファイル判定・日時パース

● エラーハンドリング
  - トークン無し or 期限切れ         → OneDriveResult.Error
  - HTTP 非 2xx                     → Error(code)
  - downloadUrl 取得失敗（動画のみ） → null を許容し Log 出力

● 補足
  - Retrofit にはシンプルな GsonConverterFactory のみ
  - OkHttpClient はデフォルト設定（リトライ・キャッシュ無し）
  - getDownloadUrl() は coroutine + Dispatchers.IO で個別実行
●ポイント
getRootItems / getFolderItems で表示リストを返しつつ、各動画ファイルについて 追加で downloadUrl を取得して上書き する二段階構成。
依存は AuthenticationManager の getSavedToken() に集約し、トークンが無効なら即エラー。
UI 側は MediaItem.downloadUrl が null かどうかでストリーム再生可否を判断。

